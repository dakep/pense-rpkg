language: r
cache: packages
dist: focal
warnings_are_errors: true
r:
- release
apt_packages:
 - libharfbuzz-dev
 - libfribidi-dev
 - libsodium-dev
r_packages:
- textshaping
- pkgdown
- rmarkdown

env:
  global:
  - PENSE_TEST_FULL="yes"
  - MAKE="make -j 2"
  - GIT_BRANCH="${TRAVIS_BRANCH}"
  - secure: "eMOWCLBOdIETPwAl4iHkLM0oz+V78Lo8eYvjVnYtFYFqelAy4dv1ZP5LjDTu+x4vpbQ8Ko4e8A77aVyDjJLSJd3Vve7gozvRh0VfICAsGImqpCAdrLx9fBH28vGRsprp6lJOW9ZxoWw4tYNsyq81KkHqHBIl0mpTo+ZHAziz7O+TPP47TC8S8gAzG/BajQfwat4BJdtMSxf590NQ9NfhwxmggjlFYSSikMNOx+oX9ys1DeTGQnwZKqhV2n8WQR8gujaVifvTBh6ZNGQ3v7MYo5Pwi85862wAkVJ5s7wrEsyp5n0TXRSKBuaDZFnA+V2Taj+V+fr2Sb22PstpED2LoWmcja9nL55LoiqkT/Y+McuWFKEfpelLz7p0UhIw/5o+R5GWsmxtLg1nL4RwAQzxaEDummZTtAnLhtG1oYici6TJsJqjkRGmtNWWzielheBJtwoxR9Vp7bldQ4dXsZrjHiJy/8LCu32E3SdldvPgTjQNk+2OwNL9SMR/7rrDX2u281I5t4N44KdrPxm6XmnWNxCmG/WQudCF4kVahiHr2yHXbzt0BsEto4y4sG7V2BkRrhxsLk63DmSP/08jGJk/BAtDBJJZfEtGY31riB9lhn5dIjslqaycKX1w0t9vqk6+ycISlhoEJ+BP7OGOhEOv3Dbfgq5lMg+jmcYVC4ciFK0="

branches:
  only:
  - main
  - "/^release\\/v?[\\d\\.]+$/"

stages:
- name: Check
  if: commit_message != "Re-build README.Rmd"
- name: "Extended checks"
  if: commit_message != "Re-build README.Rmd" AND branch != main


jobs:
- stage: Check
  after_success:
  - R CMD INSTALL .
  - git pull
  - git checkout ${TRAVIS_BRANCH}
  - Rscript -e 'rmarkdown::render("README.Rmd")'
  - git config --local user.email "ci@travis-ci.com"
  - git config --local user.name "Travis CI"
  - git add README.md || echo "Nothing added"
  - git commit README.md -m 'Re-build README.Rmd' || echo "No changes to commit"
  - git remote add originpush "https://${GITHUB_PAK}@github.com/${TRAVIS_REPO_SLUG}"
  - git push --set-upstream originpush ${TRAVIS_BRANCH} || echo "No changes to push"
  before_deploy:
  - Rscript -e 'pkgdown::build_site()'
  deploy:
    edge: true
    provider: pages
    token: ${GITHUB_PAK}
    keep_history: true
    local_dir: docs
    on:
      branch: main
- stage: "Extended checks"
  name: R-devel
  r: devel
- stage: "Extended checks"
  name: R-oldrel
  r: oldrel
