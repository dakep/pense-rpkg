#!/bin/bash

bash cleanup

ROOT_DIR="pense-rpkg"

VERSION=`sed -En 's/Version: ([0-9\.]+)/\1/p' DESCRIPTION`
PACKAGE_NAME=`sed -En 's/Package: ([a-zA-Z0-9_]+)/\1/p' DESCRIPTION`

# Fix package name and version in autoconfig.win.h
sed -i '' -E "s/(PACKAGE_(NAME|TARNAME)) .*/\1 \"${PACKAGE_NAME}\"/g" src/autoconfig.win.h
sed -i '' -E "s/(PACKAGE_VERSION) .*/\1 \"${VERSION}\"/g" src/autoconfig.win.h
sed -i '' -E "s/(PACKAGE_STRING) .*/\1 \"${PACKAGE_NAME} ${VERSION}\"/g" src/autoconfig.win.h
sed -i '' -E "s/AC_INIT.*/AC_INIT(${PACKAGE_NAME}, ${VERSION})/g" configure.ac

# Run autoconf
autoconf

bash cleanup

DIRNAME="${PACKAGE_NAME}_${VERSION}"

pushd ..

ln -sv "${ROOT_DIR}" "${PACKAGE_NAME}"

tar hczf "${ROOT_DIR}/builds/$DIRNAME.tar.gz" --exclude=".*" --exclude="*Makevars.dbg" \
    --exclude="*.Rproj" --exclude="*.o" --exclude="*.ac" --exclude="*.so"  --exclude="bundle" \
    --exclude="build" --exclude="builds/" --exclude="examples/" "${PACKAGE_NAME}"

rm "${PACKAGE_NAME}"

popd
